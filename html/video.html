<!doctype html>
<html>
  <head>
    <title>Campfire | Watching Video in %ROOM%</title>
    <meta charset='utf-8'>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      // const BASENAME = "localhost:3000";
      const BASENAME = "campfiresync.herokuapp.com";
      const ROOM = "%ROOM%";
      var videoIsYoutube = false;
      var ytAPILoaded = false;
      var ytID = "";
      var ytplayer;
      var loadYoutubePlayer;
      var startTime = 0;
      var wasPlaying = false;

      // LOAD YOUTUBE API
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      function onYouTubeIframeAPIReady() {
        ytAPILoaded = true;
        if (ytID) {
          loadYoutubePlayer();
        }
      }

      window.onload = function() {
        // YOUTUBE THINGS
        loadYoutubePlayer = function() {
          // destroy current video and let Youtube API make their own thing
          campfireVideo.parentNode.removeChild(campfireVideo);
          ytplayer = new YT.Player("yt-player", {
            videoId: ytID,
            events: {
              'onStateChange': onPlayerStateChange,
              'onReady': onPlayerReady
            }
          });
        }
        var onPlayerStateChange = function(event) {
          if (event.data == YT.PlayerState.PLAYING) {
            sendPlayToServer(ytplayer.getCurrentTime());
          }
          if (event.data == YT.PlayerState.PAUSED) {
            sendPauseToServer(ytplayer.getCurrentTime());
          }
        };

        var onPlayerReady = function(event) {
          if (wasPlaying) {
            ytplayer.seekTo(startTime);
            ytplayer.playVideo();
          }
        };

        // CONNECT TO SOCKET
        var socket = io();
        // DOCUMENT ELEMENTS
        var videoUrlInput = document.getElementById("video-url-input");
        var videoUrlInstructions = document.getElementById("video-url-instructions");
        var campfireVideo = document.getElementById("campfire-video");
        // CLIENT API
        var sendPlayToServer = function(currentTime) {
          socket.emit("clientPlay", ROOM, currentTime);
        };
        var sendPauseToServer = function(currentTime) {
          socket.emit("clientPause", ROOM, currentTime);
        };
        var sendTimestampToServer = function(currentTime) {
          socket.emit("timestamp", ROOM, currentTime);
        };
        // LISTENERS
        videoUrlInput.addEventListener("keyup", function(e) {
          if (e.keyCode == 13) {
            socket.emit("videoUrl", ROOM, videoUrlInput.value);
          }
        });
        campfireVideo.addEventListener("playing", function(e) {
          sendPlayToServer(campfireVideo.currentTime);
        });
        campfireVideo.addEventListener("pause", function(e) {
          sendPauseToServer(campfireVideo.currentTime);
        });
        // SOCKET.IO HANDLING
        socket.on("videoChosen", function(url, time, isPlaying, youtubeID) {
          videoUrlInstructions.innerHTML = "";
          // check whether this is a Youtube link or not
          if (url) {
            campfireVideo.src = url;
            campfireVideo.currentTime = time;
            if (isPlaying) {
              campfireVideo.play();
            }
          } else {
            // mark the client as ready. yes there's a race condition, yes this
            // is a hack
            videoIsYoutube = true;
            ytID = youtubeID;
            startTime = time;
            wasPlaying = isPlaying;
            if (ytAPILoaded) {
              loadYoutubePlayer();
            }
          }
        });
        socket.on("serverPlay", function(time) {
          if (videoIsYoutube) {
            ytplayer.seekTo(time, true);
            ytplayer.playVideo();
          } else {
            campfireVideo.currentTime = time;
            campfireVideo.play();
          }
        });
        socket.on("serverPause", function(time) {
          if (videoIsYoutube) {
            ytplayer.seekTo(time, true);
            ytplayer.pauseVideo();
          } else {
            campfireVideo.currentTime = time;
            campfireVideo.pause();
          }
        });
        socket.emit("firstRun", ROOM);
        setInterval(function() {
          if (videoIsYoutube) {
            if (ytplayer.getCurrentTime) {
              sendTimestampToServer(ytplayer.getCurrentTime());
            }
          } else {
            sendTimestampToServer(campfireVideo.currentTime);
          }
        }, 500);
      };
    </script>
  </head>
  <body>
    <h1>Watch a Video</h1>
    <div id="video-url-instructions">
      <p>Enter a video URL:</p>
      <input id="video-url-input" type="text">
    </div>
    <br>
    <div id="yt-player"></div>
    <video id="campfire-video" preload="auto" controls>Please use a
      modern browser.</video>
  </body>
</html>
